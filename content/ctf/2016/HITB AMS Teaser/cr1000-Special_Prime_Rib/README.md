Special Prime Rib (Crypto 1000pts)
===================================

Challenge file(s) is here: [12ca79470ba84138496e211147a33749.tgz](12ca79470ba84138496e211147a33749.tgz)

## Writeup

In this challenge, we need to attack a RSA. Indeed, that $n$ was generated by _special_ prime generator in `genrsa.py`. So we read that at first.

Let $r, s$ is some odd number, $p = (3r^4+1)/4$, $q = (11s^4+1)/4$, and $n = pq$. $n$ is RSA modulus, and $p < q$.

We use factor method proposed by [1]. This method based CM-method, the "core" theorem is following that:

### Theorem 1

> Let $N$ be an integer and $p$ a prime factor of $N$ having the form (1):
> 
> $$ p = (DV^2 + 1) / 4, D, V\in \mathbb{Z} $$
> 
> where $D$ is non-square. Let $H_D(j)$ be the class polynomial of discriminant $D$, and $E/\mathbb{Z}\_N$ an elliptic curve having the $j$-invariant $j_0$ given by Eq.(4):
> $$ E/\mathbb{K} : y^2 = x^3 + Ax + B, A, B\in\mathbb{K}, 4A^3 + 27B^2\ne 0$$
> where $j_0$ is a root of $H\_D(j)$. Moreover, for any point $(\mathcal{O}\ne)P\in E(\mathbb{Z}\_N)$, compute
> $$ NP = (a\_N/d^2\_N, b\_N/d^3\_N)$$
> and $g = \gcd(N, d\_N)$. Then, if $g\ne 0$, $g$ is a non-trivial divisor of $N$ (multiple of $p$) with the probability, 
> $$\begin{cases}1/6 & if\ D = 3,\\\\1/4 & if\ D = 1,\\\\1/2 & otherwise.\end{cases}$$

Proof: See [1] p.9.

---

Let $r' = r^2$ and $s' = s^2$. So, we write $p$, $q$ as $p = (3r'^2 + 1) / 4$, $q = (11s'^2 + 1) / 4$. Therefore we can factor the $n$ using Theorem 1 with $D = 3$ or $D = 11$.

We implement the algorithm for $D = 3$ (because this case is very easy to implement). 

[factor.sage](factor.sage)

```python
from sage.all import *

def factor_shirase_d_3(n):
  F = Zmod(n)
  while True:
    x0 = ZZ.random_element(0, n)
    y0 = ZZ.random_element(0, n)
    B = y0^2 - x0^3
    E = EllipticCurve(F, [0, B])
    # j invariant of `E` is 0
    # because, Hilbert's Class Polynomial for discriminant 3 has root 0.
    P = E(x0, y0)
    try:
      NP = n * P
    except Exception, e:
      # Can't calculate Inverse of some number `k`.
      # iff 1 < g < n then g is non-trivial factor of n where g := gcd(n, k).
      p = gcd(ZZ(e.args[0].split(' ')[2]), n)
      if is_prime(p):
        return p
    x, y, z = map(ZZ, tuple(NP))
    dn2 = gcd(x, y)
    if not dn2.is_square():
      continue
    dn = dn2.nth_root(2)
    if not (x % dn^2 == 0 and y % dn^3 == 0):
      continue
    g = gcd(n, dn)
    if g > 1 and n % g == 0:
        return g


if __name__ == '__main__':
  # HITB AMS 2016 Teaser: Crypto 1000 Special Prime Rib
  n = 0x80fab241e21aacbb5a0c0c58ce7d8a3f844f3f76c2b1006278d79cdd333550ab5f5f86425fdbf06063481d7d7922f1c17083532285b1d8faee843d8a02e74f277a47084bc5585f0d16a2ab7f2e2c074a274c9b890b05a4ed05739f9baeaa501c265d68c04c146a5daed6ef5e0a45aa7c9ae1e7c3741c39f7f00936d1d627bc5b
  p = factor_shirase_d_3(n)
  q = n / p
  assert n == p*q
```

we have $p$, $q$. so, we can decrypt the message.

Flag: `hitb{a17eb490dcdebe1e7db6134e23b840bd}`

# References

* [1] Masaaki Shirase. 2017. [_Condition on composite numbers easily factored with elliptic curve method_](https://eprint.iacr.org/2017/403)